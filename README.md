# Dumping dumpheap results to database
1. Clone https://github.com/MarkKharitonov/DumpHeap2DB
1. Build the code
1. Run `Output2DB.exe -h`

Typically only one parameter must be given - the file containing the output of dumpheap. No need to preprocess it - the tool knows to take the right entries. Make sure it is **not** the `-stat` output.

# Preparing to debug a linux core dump
1. Enable WSL2 - google for details.
1. Install Linux distro
   - I installed Ubuntu 18.04. Could not install it from the Windows Store, but found this answer - https://stackoverflow.com/a/64872285/80002 and it helped to figure it out.
1. Install WSL2
   - Networking does not work out of the box. I followed the instructions here to make it work - https://stackoverflow.com/a/65325532/80002
   - I was unable to make networking work when the host (i.e. my workstation) has VPN running.
1. Install lldb
1. Install dotnet-symbol
1. Place the core dump in a dedicated directory.
   - E.g. if the Windows directory is `C:\Temp\xyz` then it would be `/mnt/c/Temp/xyz` inside WSL2.
1. Download the right dotnet executable
   - `dotnet symbol --host-only TheCoreDumpFilePath`

# Scripting lldb
`man lldb` is your friend. Have a look at the switches `-b`, `-o` and `-s`.

The scripts currently hard code the core dump name - you will have to replace it with the actual core dump name as needed.

## string.sh
This script accepts an address of a .NET string and saves its content to a file. The file name can be given or it can be generated by default.

### Example 1
```
mark@L-R910LPKW:/mnt/c/Temp/Hub$ ./string.sh 7FBC74503100
Added Microsoft public symbol server
(lldb) target create "dotnet" --core "core_20220303_012350"
Core file '/mnt/c/Temp/Hub/core_20220303_012350' (x86_64) was loaded.
(lldb) x -c363986 -b -o string@0x7FBC74503100.txt --force 0x7FBC7450310C
363986 bytes written to '/mnt/c/Temp/Hub/string@0x7FBC74503100.txt'
mark@L-R910LPKW:/mnt/c/Temp/Hub$
```

## cmd.sh
Runs the given lldb command, saves the output to a file, but also outputs it to the console.

There are 2 variants of the script:
- **cmd2file.sh** - saves the command output to a file without also sending it to the console.
- **cmd2stdout.sh** - sends the output to the console without also saving it in a file

### Example 1
```
mark@L-R910LPKW:/mnt/c/Temp/Hub$ ./cmd2file.sh gcroot 7FBE68046C80
cat gcroot_7FBE68046C80.output.txt
mark@L-R910LPKW:/mnt/c/Temp/Hub$
```
The `cmd2file.sh` outputs the `cat` command you would run to see the command output. As you can see the generated file name is **gcroot_7FBE68046C80.output.txt**

### Example 2
```
mark@L-R910LPKW:/mnt/c/Temp/Hub$ ./cmd2stdout.sh dumpobj 7FBE68046C80
Added Microsoft public symbol server
(lldb) target create "dotnet" --core "core_20220303_012350"
Core file '/mnt/c/Temp/Hub/core_20220303_012350' (x86_64) was loaded.
(lldb) dumpobj 7FBE68046C80
Name:        System.String
MethodTable: 00007fc315080f90
EEClass:     00007fc314fee2f0
Size:        74(0x4a) bytes
File:        /usr/share/dotnet/shared/Microsoft.NETCore.App/3.1.0/System.Private.CoreLib.dll
String:      4kfy0763t8rc2w3ez3scj0s4dr
Fields:
              MT    Field   Offset                 Type VT     Attr            Value Name
00007fc31507a0e8  400022a        8         System.Int32  1 instance               26 _stringLength
00007fc315076f00  400022b        c          System.Char  1 instance               34 _firstChar
00007fc315080f90  400022c      108        System.String  0   static 00007fc067fff360 Empty
mark@L-R910LPKW:/mnt/c/Temp/Hub$
```

# Relevant SO questions (welcome to upvote)
- https://stackoverflow.com/questions/71822324/what-does-the-pinned-handle-in-the-gcroot-result-mean-practically-in-the-context
- https://stackoverflow.com/questions/71817630/how-to-run-sos-extension-commands-through-the-lldb-python-api
- https://stackoverflow.com/questions/71805346/sosex-alternative-for-linux-net-core-memory-dumps
- https://stackoverflow.com/questions/71803641/how-can-we-script-dotnet-dump-analyze-commands
